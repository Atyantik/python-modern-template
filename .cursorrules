# Cursor AI Rules for This Project

## STOP! READ THIS FIRST - MANDATORY SESSION MANAGEMENT

**BEFORE doing ANYTHING in this session, you MUST run:**

```bash
uv run ai-start-task "Your task description"
```

**If you have NOT run this command yet, STOP NOW and run it!**

This is NOT optional. Every Cursor session MUST start with `ai-start-task`.

**During work:**
```bash
uv run ai-log "Progress message"
uv run ai-update-plan "Completed item"

# Customize your plan (add task-specific steps, remove irrelevant items)
uv run ai-update-plan --add "Specific task for this feature" --phase "Phase 2"
uv run ai-update-plan --remove "Generic irrelevant item"
uv run ai-update-plan --rename "Generic item" --to "Specific detailed item"
```

**When finishing:**
```bash
uv run ai-finish-task --summary="What you accomplished"
```

See `@AI_DOCS/ai-tools.md` for complete workflow and all ai-update-plan features.

---

## Overview

This project follows strict Test-Driven Development (TDD) and code quality standards. All AI-assisted code must adhere to these rules.

**Primary Directive:** ALWAYS write tests BEFORE implementation code.

## Shared Documentation

For comprehensive guidelines, reference these shared documents:

- **@AI_DOCS/ai-tools.md** - AI session management tools (MANDATORY workflow)
- **@AI_DOCS/ai-skills.md** - Specialized skills and agents (manual workflows for Cursor)
- **@AI_DOCS/tdd-workflow.md** - Test-Driven Development process and testing standards
- **@AI_DOCS/code-conventions.md** - Code style, formatting, and best practices
- **@AI_DOCS/project-context.md** - Tech stack, architecture, and project structure

See `@AI_DOCS/ai-skills.md` for test-generator, coverage-analyzer, quality-fixer, and quality review workflows.

## Test-Driven Development (MANDATORY)

### Rule 1: Tests First, Always
- **ALWAYS** write tests BEFORE implementing functionality
- Start every feature/bug fix by creating or updating test cases
- Tests must be in `tests/` directory following existing patterns

### Rule 2: Real Code Over Mocks
- Use **real code and data** from the codebase whenever possible
- Minimize use of mocks and fixtures
- Only use mocks/fixtures when:
  - External API calls (network requests)
  - Database connections
  - File system operations that would be destructive
  - Time-dependent operations
- **Never** mock internal functions that can be tested directly

### Rule 3: Coverage Requirements
- Maintain **minimum 80% code coverage** (enforced by pytest)
- Check coverage with: `make coverage`
- New code should aim for 100% coverage
- Update tests when modifying existing code

### Rule 4: Test Patterns
Follow existing test patterns in `tests/`:
```python
# Class-based organization
class TestFeatureName:
    """Test cases for feature."""

    def test_specific_behavior(self) -> None:
        """Test description."""
        # Arrange
        input_data = "real data"

        # Act
        result = function_to_test(input_data)

        # Assert
        assert result == expected_value
```

Use pytest features:
- `@pytest.mark.parametrize` for multiple test cases
- Fixtures in `conftest.py` for shared setup (sparingly)
- `capsys` for testing output
- Type hints in all test functions

See `@AI_DOCS/tdd-workflow.md` for complete TDD workflow and examples.

## Code Quality (MANDATORY)

### Rule 5: Run make check After Every Change
After writing ANY code, you MUST run:
```bash
make check
```

This runs:
1. `make format` - Black + isort formatting
2. `make lint` - Ruff + mypy + Pylint
3. `make test` - Full test suite with coverage

**Never proceed if `make check` fails!**

### Rule 6: Fix All Quality Issues
- Black formatting: 88-character line length
- isort: Black-compatible import sorting
- Ruff: Fix all linting errors (run with --fix)
- mypy: Strict type checking, no untyped code
- Pylint: Must score 10.0/10.0
- Formatter harmony: write code so Black and Ruff agree (e.g., move long
  assertion messages into variables instead of relying on multi-line wrapping)

### Rule 7: Pre-commit Hooks
- Pre-commit hooks will run automatically on `git commit`
- If hooks fail, fix issues before committing
- Run manually: `make pre-commit`

### Rule 8: No Duplicate Code
- Follow DRY (Don't Repeat Yourself) principle
- Refactor duplicated logic into reusable functions
- Check for similar code before implementing

See `@AI_DOCS/code-conventions.md` for complete code quality standards.

## Type Hints (MANDATORY)

### Rule 9: Type Everything
```python
# ✅ Correct
def process_data(input: str, count: int = 5) -> dict[str, int]:
    """Process the input data."""
    return {"result": len(input) * count}

# ❌ Wrong - no type hints
def process_data(input, count=5):
    return {"result": len(input) * count}
```

- All function parameters must have type hints
- All return values must have type hints
- Use `from __future__ import annotations` for forward references
- For complex types, use `typing` module

See `@AI_DOCS/code-conventions.md` for complete type hints and conventions.

## Project Structure

### Rule 10: Follow src Layout
```
src/
  └── python_modern_template/
      ├── __init__.py     # Package exports
      └── main.py         # Implementation
tests/
  ├── conftest.py         # Shared fixtures
  └── test_main.py        # Test files
AI_DOCS/                  # Shared AI documentation
  ├── tdd-workflow.md
  ├── ai-tools.md
  ├── code-conventions.md
  └── project-context.md
```

- All implementation code in `src/python_modern_template/`
- All tests in `tests/`
- No root-level scripts (use entry points in pyproject.toml)

### Rule 11: Imports
```python
# ✅ Correct - import from package
from python_modern_template import function_name

# ❌ Wrong - don't use src prefix
from src.python_modern_template import function_name
```

See `@AI_DOCS/project-context.md` for complete project structure and architecture.

## Security

### Rule 12: Security First
- Never commit secrets, API keys, or credentials
- Use environment variables for sensitive data
- CI runs Bandit (security linter) and Safety (vulnerability checker)
- Fix all security warnings before proceeding

## Development Workflow

### Complete TDD Cycle
1. **Write failing test** for new feature/fix
2. **Run tests** to confirm they fail: `make test`
3. **Implement** minimal code to make test pass
4. **Run tests** again to confirm they pass
5. **Refactor** if needed
6. **Run make check** to ensure quality
7. **Commit** if all checks pass

### Before Every Commit
```bash
make check              # Format, lint, and test
make pre-commit        # Run all pre-commit hooks
```

### Example TDD Session
```bash
# 1. Write test in tests/test_feature.py
# 2. Run tests (should fail)
make test

# 3. Implement feature in src/python_modern_template/feature.py
# 4. Run tests (should pass)
make test

# 5. Check code quality
make check

# 6. If all pass, commit
git add .
git commit -m "Add feature X with tests"
```

See `@AI_DOCS/tdd-workflow.md` and `@AI_DOCS/ai-tools.md` for complete workflow examples.

## Required Development Workflow

Follow this workflow for every code change:

1. Write tests first (TDD approach)
2. Use real code/data instead of mocks when possible
3. Run `make check` after every change
4. Add type hints to all functions
5. Maintain coverage above 80%
6. Follow existing code patterns in the codebase
7. Fix all quality issues before committing
8. Use AI session tools (`ai-start-task`, `ai-finish-task`)

## Quality Gates

Code must pass ALL of these before being committed:
1. ✅ Tests written first (TDD)
2. ✅ All tests pass (`make test`)
3. ✅ Coverage ≥ 80% (`make coverage`)
4. ✅ Black formatting (`make format`)
5. ✅ isort import sorting (`make format`)
6. ✅ Ruff linting (`make lint`)
7. ✅ mypy type checking (strict) (`make lint`)
8. ✅ Pylint score 10/10 (`make lint`)
9. ✅ Pre-commit hooks pass (`make pre-commit`)
10. ✅ No security issues (Bandit/Safety in CI)

## Reference Commands

```bash
make help          # Show all available commands
make test          # Run tests
make coverage      # Run tests with coverage report
make format        # Format with Black + isort
make lint          # Run all linters
make check         # Format + lint + test (use before commits)
make pre-commit    # Run pre-commit hooks
make clean         # Clean generated files
make build         # Build package
```

## Complete Reference Documentation

For detailed guidelines on each aspect of development:

1. **@AI_DOCS/ai-tools.md** - Session management, logging, context tracking (MANDATORY)
2. **@AI_DOCS/ai-skills.md** - Specialized skills and agents for quality and testing
3. **@AI_DOCS/tdd-workflow.md** - TDD process, testing standards, coverage requirements
4. **@AI_DOCS/code-conventions.md** - Code style, formatting, best practices, documentation
5. **@AI_DOCS/project-context.md** - Tech stack, architecture, dependencies, CI/CD

These shared documents are the single source of truth for all AI coding assistants.

---

**Remember:** Quality over speed. Taking time to write tests first and ensure quality will save debugging time later.
