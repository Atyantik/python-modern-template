"""Security checking script using Bandit.

This script runs security analysis tools on the codebase to identify
potential security vulnerabilities.
"""

from __future__ import annotations

import shutil
import subprocess
import sys
from pathlib import Path

from scripts.quality.config import load_config


def run_command(cmd: list[str], description: str, optional: bool = False) -> bool:
    """Run a shell command and return success status.

    Args:
        cmd: Command and arguments to run
        description: Description of what the command does
        optional: If True, skip if command not found

    Returns:
        True if command succeeded (exit code 0), False otherwise
    """
    # Check if command exists
    if optional and not shutil.which(cmd[0]):
        print(f"⚠️  {description} - SKIPPED (tool not installed)")
        return True

    print(f"▶ {description}...")
    print(f"  Running: {' '.join(cmd)}")
    result = subprocess.run(cmd, cwd=Path.cwd())
    if result.returncode == 0:
        print(f"✅ {description} - PASSED")
        return True
    print(f"❌ {description} - FAILED")
    return False


def security_check() -> int:
    """Run security checks using Bandit and optionally Safety.

    Returns:
        Exit code (0 for success, 1 for failure)
    """
    config = load_config()
    paths = config.code_paths

    print("\n" + "=" * 70)
    print("SECURITY CHECKS")
    print("=" * 70)
    print(f"Paths: {', '.join(paths)}")
    print("=" * 70 + "\n")

    success = True

    # Run Bandit (security linter for Python code)
    if shutil.which("bandit"):
        bandit_cmd = ["bandit", "-r"] + paths
        if not run_command(bandit_cmd, "Bandit (security linter)"):
            success = False
    else:
        print("⚠️  Bandit not installed - skipping security linting")
        print("   Install with: uv add --dev bandit")

    # Run Safety (check dependencies for known vulnerabilities)
    # This is optional as it requires API access
    if shutil.which("safety"):
        safety_cmd = ["safety", "check"]
        run_command(safety_cmd, "Safety (dependency vulnerabilities)", optional=True)
    else:
        print("\n⚠️  Safety not installed - skipping dependency security check")
        print("   Install with: uv add --dev safety")

    print("\n" + "=" * 70)
    if success:
        print("✅ SECURITY CHECKS PASSED")
    else:
        print("❌ SECURITY CHECKS FAILED")
    print("=" * 70 + "\n")

    return 0 if success else 1


def main() -> int:
    """Entry point for the security script.

    Returns:
        Exit code (0 for success, 1 for failure)
    """
    return security_check()


if __name__ == "__main__":
    sys.exit(main())
