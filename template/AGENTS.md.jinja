# AI Agent Instructions

## STOP! READ THIS FIRST - MANDATORY SESSION MANAGEMENT

**BEFORE doing ANYTHING in this session, you MUST run:**

```bash
uv run ai-start-task "Your task description"
```

**If you have NOT run this command yet, STOP NOW and run it!**

This is NOT optional. Every AI agent MUST start every session with `ai-start-task`.

**During work:**
```bash
uv run ai-log "Progress message"
uv run ai-update-plan "Completed item"

# Customize your plan (add task-specific steps, remove irrelevant items)
uv run ai-update-plan --add "Specific task for this feature" --phase "Phase 2"
uv run ai-update-plan --remove "Generic irrelevant item"
uv run ai-update-plan --rename "Generic item" --to "Specific detailed item"
```

**When finishing:**
```bash
uv run ai-finish-task --summary="What you accomplished"
```

See `@AI_DOCS/ai-tools.md` for complete workflow and all ai-update-plan features.

---

## Overview

**Universal instructions for all AI coding assistants working on this project**

**Primary Directive:** ALWAYS write tests BEFORE implementation code (Test-Driven Development).

## Shared Documentation

For comprehensive guidelines, reference these shared documents:

- **@AI_DOCS/ai-tools.md** - AI session management tools (MANDATORY workflow)
- **@AI_DOCS/tdd-workflow.md** - Test-Driven Development process and testing standards
- **@AI_DOCS/code-conventions.md** - Code style, formatting, and best practices
- **@AI_DOCS/project-context.md** - Tech stack, architecture, and project structure

## Quick Reference

| Aspect | Requirement |
|--------|-------------|
| **Session Management** | Use `ai-start-task` before starting, `ai-finish-task` when done |
| **Progress Tracking** | Log all important steps with `ai-log` |
| **Development Approach** | Test-Driven Development (TDD) - Tests First! |
| **Minimum Coverage** | 80% (enforced by pytest) |
| **Mocks/Fixtures** | Minimize - use real code when possible |
| **Quality Check** | `make check` must pass before committing |
| **Type Hints** | Required on all functions (mypy strict mode) |
| **Code Style** | Black (88 chars) + isort + Ruff + Pylint (10/10) |
| **Formatter Harmony** | Let Black decide layout; refactor (e.g., use message variables) so Ruff agrees |

See `@AI_DOCS/ai-tools.md` for complete AI tools workflow and `@AI_DOCS/tdd-workflow.md` for TDD process

## AI Configuration Files (2025 Standards)

Each AI tool has its specific configuration file:

| Tool | Configuration File | Location |
|------|-------------------|----------|
| **All Tools** | `AGENTS.md` | Root directory (this file) |
| **Cursor IDE** | `.cursorrules` | Root directory |
| **Claude Code** | `CLAUDE.md` | Root directory |
| **GitHub Copilot** | `copilot-instructions.md` | `.github/` directory |
| **Gemini Code Assist** | `styleguide.md` | `.gemini/` directory |
| **Aider AI** | `.aider.conf.yml` | Root directory |

**Note**: All these files reference the shared documentation in `AI_DOCS/` or contain the mandatory AI tools workflow and TDD requirements.

## Core Principles

### 1. Test-Driven Development (TDD) is Non-Negotiable

**The Workflow:**
```
1. Write failing test
2. Run test (confirm it fails)
3. Write minimal code to pass test
4. Run test (confirm it passes)
5. Refactor if needed
6. Run make check (all quality gates)
7. Commit
```

See `@AI_DOCS/tdd-workflow.md` for complete TDD workflow with examples.

### 2. Minimize Mocks - Use Real Code

**✅ Preferred Approach:**
```python
# Use real function from codebase
from {{ package_name }}.main import main

def test_main_returns_zero() -> None:
    """Template CLI returns 0 to signal success."""
    assert main() == 0
```

**❌ Avoid Unless Necessary:**
```python
# Only mock external dependencies
@patch('requests.get')  # OK - external API
def test_api_call(mock_get):
    ...

# Don't mock internal functions
@patch('{{ package_name }}.utils.helper')  # Bad - use real helper
```

**When to Mock:**
- External API calls (HTTP requests)
- Database connections
- File system writes
- Time/date operations (`datetime.now()`)
- Random number generation
- Environment variables for testing different configs

**When NOT to Mock:**
- Internal project functions
- Pure functions (deterministic output)
- Simple data transformations
- Business logic

See `@AI_DOCS/tdd-workflow.md` for complete testing guidelines and mocking rules.

### 3. Run Quality Checks Every Time

**After writing ANY code:**
```bash
make check
```

This single command runs:
- Format code (Black + isort)
- Lint code (Ruff + mypy + Pylint)
- Run all tests with coverage

**Never commit if `make check` fails!**

See `@AI_DOCS/code-conventions.md` for complete quality standards.

### 4. Keep Black and Ruff in Sync

- After edits, run `pre-commit run --files …` (or `make format`) to ensure both formatters agree.
- Prefer explicit code over formatter magic: store long assertion messages (or other arguments)
  in variables instead of relying on multi-line wrapping that tools format differently.
- If a formatter keeps rewriting something, refactor the code so the intent is clear and stable.

## Detailed Requirements

### Testing Standards

See `@AI_DOCS/tdd-workflow.md` for comprehensive testing standards.

Key points:
- Tests in `tests/` directory mirror `src/` structure
- Test files named `test_*.py`
- Use parametrized tests for multiple cases
- Minimum 80% coverage (enforced)
- Shared fixtures in `conftest.py` (use sparingly)

### Code Quality Standards

See `@AI_DOCS/code-conventions.md` for complete code conventions.

Key points:
- Type hints required on all functions (mypy strict mode)
- Line length: 88 characters (Black)
- Import sorting: isort with Black profile
- Docstrings: Google style format
- Linting: Ruff + mypy + Pylint (10/10 score required)

### Project Structure

See `@AI_DOCS/project-context.md` for complete project structure and architecture.

```
{{ project_slug }}/
├── AI_DOCS/                   # Shared AI documentation (NEW)
├── src/
│   └── {{ package_name }}/
├── tests/
├── scripts/ai_tools/          # AI context management tools
├── .ai-context/               # AI session files
├── .github/
└── [config files]
```

### Import Conventions

```python
# ✅ Correct - import from package name
from {{ package_name }} import main
from {{ package_name }}.module import ClassName

# ❌ Wrong - don't use src prefix
from src.{{ package_name }} import main
```

## Development Commands

```bash
# Setup
make install              # Install dependencies + pre-commit hooks
uv pip install -e .       # Install package in editable mode

# Development Cycle
make test                 # Run tests
make coverage             # Run tests with coverage report
make format               # Format code (Black + isort)
make lint                 # Run linters (Ruff + mypy + Pylint)
make check                # ALL quality checks (format + lint + test)

# Maintenance
make clean                # Remove generated files
make update               # Update dependencies
make pre-commit           # Run pre-commit hooks manually

# Building
make build                # Build distribution package

# Help
make help                 # Show all commands
```

See `@AI_DOCS/project-context.md` for complete development workflow.

## Quality Gates (All Must Pass)

Before committing code, ensure:

1. ✅ **Tests written FIRST** (TDD)
2. ✅ **All tests pass**: `make test`
3. ✅ **Coverage ≥ 80%**: `make coverage`
4. ✅ **Formatted**: Black + isort via `make format`
5. ✅ **Linted**: Ruff, mypy, Pylint via `make lint`
6. ✅ **Pre-commit hooks pass**: `make pre-commit`
7. ✅ **Type hints everywhere**: mypy strict mode
8. ✅ **No security issues**: CI runs Bandit + Safety

See `@AI_DOCS/tdd-workflow.md` and `@AI_DOCS/code-conventions.md` for complete quality requirements.

## Security Guidelines

- Never commit secrets, API keys, or credentials
- Use environment variables for sensitive configuration
- Check `.gitignore` before committing
- CI automatically runs security scans (Bandit + Safety)
- Fix all security warnings immediately

## Documentation Requirements

### Code Documentation
```python
def public_function(param: str) -> int:
    """Brief one-line description.

    More detailed explanation if needed. Describe what the
    function does, not how it does it.

    Args:
        param: Description of parameter

    Returns:
        Description of return value

    Raises:
        ValueError: When param is invalid
    """
```

See `@AI_DOCS/code-conventions.md` for complete documentation standards.

### When to Update README.md
- Adding user-facing features
- Changing installation steps
- New CLI commands or options
- Modifying project structure
- Adding development requirements

## Best Practices

- DRY (Don't Repeat Yourself)
- Small, Focused Functions
- Explicit over Implicit

See `@AI_DOCS/code-conventions.md` for complete best practices and examples.

## Troubleshooting

### Tests Failing
```bash
# Run tests with verbose output
make test

# Run specific failing test
uv run pytest tests/test_file.py::test_name -vv

# Check coverage
make coverage
```

### Linting Errors
```bash
# Auto-fix formatting
make format

# Check what linter is failing
make lint

# Fix Ruff issues automatically
uv run ruff check --fix src tests
```

### Import Errors
```bash
# Reinstall package in editable mode
uv pip install -e .

# Check imports are correct (no 'src.' prefix)
uv run mypy src tests
```

## Platform-Specific Instructions

For platform-specific details, see:
- **Cursor**: `.cursorrules`
- **Claude**: `CLAUDE.md`
- **Gemini**: `.gemini/styleguide.md`
- **Aider**: `.aider.conf.yml`
- **Copilot**: `.github/copilot-instructions.md`

All tools reference the shared documentation in `AI_DOCS/` for consistency.

---

**Remember**: Write tests first, use real code, run `make check`, maintain quality. This discipline prevents bugs and saves time.

## Complete Reference Documentation

For detailed guidelines on each aspect of development:

1. **@AI_DOCS/ai-tools.md** - Session management, logging, context tracking (MANDATORY)
2. **@AI_DOCS/tdd-workflow.md** - TDD process, testing standards, coverage requirements
3. **@AI_DOCS/code-conventions.md** - Code style, formatting, best practices, documentation
4. **@AI_DOCS/project-context.md** - Tech stack, architecture, dependencies, CI/CD

These shared documents are the single source of truth for all AI coding assistants.
